---
- name: Reboot primary host and confirm it's back
  hosts: "{{ primary | default('hlct-ns1') }}"
  gather_facts: false
  any_errors_fatal: true
  vars:
    reboot_timeout: 600       # seconds to wait for reboot/SSH recovery
    post_reboot_delay: 10     # seconds to wait after SSH returns before running health checks
  tasks:
    - name: Reboot primary (module)
      ansible.builtin.reboot:
        reboot_timeout: "{{ reboot_timeout }}"
        pre_reboot_delay: 0
        post_reboot_delay: "{{ post_reboot_delay }}"
        test_command: whoami

    - name: Wait for SSH on primary to become available
      ansible.builtin.wait_for_connection:
        timeout: "{{ reboot_timeout }}"

    - name: Simple health check on primary (hostname)
      ansible.builtin.command:
        cmd: hostname
      register: primary_hostname
      changed_when: false

    - name: Show primary health check result
      ansible.builtin.debug:
        msg: "Primary {{ inventory_hostname }} responded with hostname: {{ primary_hostname.stdout }}"

- name: Reboot secondary host after primary is confirmed up
  hosts: "{{ secondary | default('hlct-ns2') }}"
  gather_facts: false
  vars:
    reboot_timeout: 600
    post_reboot_delay: 10
  tasks:
    - name: Reboot secondary (module)
      ansible.builtin.reboot:
        reboot_timeout: "{{ reboot_timeout }}"
        pre_reboot_delay: 0
        post_reboot_delay: "{{ post_reboot_delay }}"
        test_command: whoami

    - name: Wait for SSH on secondary to become available
      ansible.builtin.wait_for_connection:
        timeout: "{{ reboot_timeout }}"

    - name: Simple health check on secondary (hostname)
      ansible.builtin.command:
        cmd: hostname
      register: secondary_hostname
      changed_when: false

    - name: Show secondary health check result
      ansible.builtin.debug:
        msg: "Secondary {{ inventory_hostname }} responded with hostname: {{ secondary_hostname.stdout }}"
